{% extends "base.html" %}

{% block title %}Resultados - Calculadora de Importação{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i data-feather="bar-chart-2" class="me-2"></i>Resultados da Análise</h2>
            <p class="text-muted">{{ calculation.product_name }} - NCM: {{ calculation.ncm_code }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <small class="text-muted">Cálculo realizado em {{ calculation.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
    </div>

    <div class="row">
        <!-- Main Results -->
        <div class="col-lg-8">
            <!-- Summary Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Valor CIF</h6>
                            <h4 class="text-primary">{{ currency_service.format_currency_brl(calculation.total_cost_brl) }}</h4>
                            <small class="text-muted">Cost, Insurance & Freight</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Total de Impostos</h6>
                            <h4 class="text-warning">{{ currency_service.format_currency_brl(calculation.total_taxes_brl) }}</h4>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Custo Total</h6>
                            <h4 class="text-success">{{ currency_service.format_currency_brl(calculation.final_cost_brl) }}</h4>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Carga Tributária</h6>
                            <h4 class="text-info">{{ "%.1f"|format((calculation.total_taxes_brl / calculation.total_cost_brl) * 100) }}%</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tax Breakdown -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="pie-chart" class="me-2"></i>Breakdown dos Impostos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Imposto</th>
                                    <th>Alíquota</th>
                                    <th>Base de Cálculo</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tax_type, tax_data in taxes.items() %}
                                <tr>
                                    <td>
                                        <strong>{{ tax_type }}</strong>
                                        <br><small class="text-muted">
                                            {% if tax_type == 'II' %}Imposto de Importação
                                            {% elif tax_type == 'IPI' %}Imposto sobre Produtos Industrializados
                                            {% elif tax_type == 'PIS' %}PIS-Importação
                                            {% elif tax_type == 'COFINS' %}COFINS-Importação
                                            {% elif tax_type == 'ICMS' %}ICMS
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>{{ "%.2f"|format(tax_data.rate) }}%</td>
                                    <td>{{ currency_service.format_currency_brl(tax_data.base_value) }}</td>
                                    <td class="text-end">{{ currency_service.format_currency_brl(tax_data.amount) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cost Comparison Chart -->
                    <div class="text-center mt-4">
                        <canvas id="costComparisonChart" width="400" height="200"></canvas>
                        <div id="profit-display" class="mt-3"></div>
                        <small class="text-muted">* Informe um preço de venda na análise de rentabilidade para visualizar a comparação</small>
                    </div>
                </div>
            </div>

            <!-- Profitability Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="trending-up" class="me-2"></i>Análise de Rentabilidade</h5>
                </div>
                <div class="card-body">
                    <form id="profitability-form">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ profitability_form.selling_price_brl.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ profitability_form.selling_price_brl() }}
                                </div>
                                <div class="form-text">Informe o preço de venda desejado para análise de rentabilidade</div>
                            </div>
                        </div>

                        <div class="text-center">
                            {{ profitability_form.submit() }}
                        </div>
                    </form>

                    <!-- Profitability Results -->
                    <div id="profitability-results" class="mt-4" style="display: none;">
                        <hr>
                        <h6>Resultados da Análise de Rentabilidade</h6>
                        <div class="row" id="profitability-cards"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Product Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i data-feather="package" class="me-2"></i>Detalhes do Produto</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-6">Produto:</dt>
                        <dd class="col-6">{{ calculation.product_name }}</dd>
                        
                        <dt class="col-6">NCM:</dt>
                        <dd class="col-6">{{ calculation.ncm_code }}</dd>
                        
                        <dt class="col-6">Quantidade:</dt>
                        <dd class="col-6">{{ calculation.quantity }} un.</dd>
                        
                        <dt class="col-6">Valor Unit.:</dt>
                        <dd class="col-6">{{ currency_service.format_currency_usd(calculation.unit_value_usd) }}</dd>
                        
                        <dt class="col-6">Origem:</dt>
                        <dd class="col-6">{{ calculation.origin_country }}</dd>
                        
                        <dt class="col-6">Transporte:</dt>
                        <dd class="col-6">
                            {% if calculation.transport_mode == 'MARITIME' %}Marítimo
                            {% elif calculation.transport_mode == 'AIR' %}Aéreo
                            {% elif calculation.transport_mode == 'ROAD' %}Rodoviário
                            {% endif %}
                        </dd>
                        
                        <dt class="col-6">Câmbio:</dt>
                        <dd class="col-6">R$ {{ "%.4f"|format(calculation.exchange_rate) }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Additional Costs -->
            {% if costs %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i data-feather="dollar-sign" class="me-2"></i>Custos Adicionais</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for cost in costs %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ cost.description }}
                            {% if cost.amount_usd %}
                                <span>{{ currency_service.format_currency_usd(cost.amount_usd) }}</span>
                            {% else %}
                                <span>{{ currency_service.format_currency_brl(cost.amount_brl) }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h6><i data-feather="settings" class="me-2"></i>Ações</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveScenarioModal">
                            <i data-feather="bookmark" class="me-2"></i>Salvar como Cenário
                        </button>
                        
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i data-feather="printer" class="me-2"></i>Imprimir Relatório
                        </button>
                        
                        <a href="{{ url_for('new_calculation') }}" class="btn btn-success">
                            <i data-feather="plus-circle" class="me-2"></i>Nova Análise
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Scenario Modal -->
<div class="modal fade" id="saveScenarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salvar Cenário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scenario-form">
                    {{ scenario_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ scenario_form.name.label(class="form-label") }}
                        {{ scenario_form.name() }}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Calculate values for the chart
let totalAdditionalCosts = 0;
{% if costs %}
{% for cost in costs %}
totalAdditionalCosts += parseFloat({{ cost.amount_brl }}) || 0;
{% endfor %}
{% endif %}

// Initialize chart data
const chartData = {
    cifValue: parseFloat({{ calculation.total_cost_brl }}) || 0,
    taxesValue: parseFloat({{ calculation.total_taxes_brl }}) || 0,
    additionalCostsValue: totalAdditionalCosts
};

chartData.totalCostValue = chartData.cifValue + chartData.taxesValue + chartData.additionalCostsValue;

// Cost comparison chart
const ctx = document.getElementById('costComparisonChart');
if (ctx) {
    const costComparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Composição de Custos', 'Preço de Venda'],
            datasets: [{
                label: 'Valor CIF',
                data: [chartData.cifValue, 0],
                backgroundColor: '#0d6efd',
                borderColor: '#0d6efd',
                borderWidth: 1
            }, {
                label: 'Impostos',
                data: [chartData.taxesValue, 0],
                backgroundColor: '#dc3545',
                borderColor: '#dc3545',
                borderWidth: 1
            }, {
                label: 'Custos Adicionais',
                data: [chartData.additionalCostsValue, 0],
                backgroundColor: '#ffc107',
                borderColor: '#ffc107',
                borderWidth: 1
            }, {
                label: 'Receita de Venda',
                data: [0, 0],
                backgroundColor: '#198754',
                borderColor: '#198754',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('pt-BR', {
                                style: 'currency',
                                currency: 'BRL',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            }).format(value);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === 0) return null;
                            return context.dataset.label + ': ' + 
                                new Intl.NumberFormat('pt-BR', {
                                    style: 'currency',
                                    currency: 'BRL'
                                }).format(context.parsed.y);
                        }
                    }
                }
            }
        }
    });

    // Store chart reference globally
    window.costComparisonChart = costComparisonChart;
    window.chartData = chartData;
}

// Function to update chart with selling price
function updateCostComparisonChart(sellingPrice) {
    if (!window.costComparisonChart || !window.chartData) {
        console.error('Chart não inicializado');
        return;
    }
    
    const chart = window.costComparisonChart;
    const data = window.chartData;
    
    // Update chart data
    chart.data.datasets[3].data[1] = parseFloat(sellingPrice) || 0;
    chart.update('none'); // Animate without transitions for better performance
    
    // Calculate profit
    const sellingPriceNum = parseFloat(sellingPrice) || 0;
    const profit = sellingPriceNum - data.totalCostValue;
    const profitMargin = sellingPriceNum > 0 ? (profit / sellingPriceNum) * 100 : 0;
    
    // Update profit display
    const profitDisplay = document.getElementById('profit-display');
    if (profitDisplay && sellingPriceNum > 0) {
        const alertClass = profit > 0 ? 'success' : 'danger';
        const profitFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(profit);
        const totalCostFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(data.totalCostValue);
        
        profitDisplay.innerHTML = `
            <div class="alert alert-${alertClass}" role="alert">
                <div class="row text-center">
                    <div class="col-md-4">
                        <strong>Custo Total</strong><br>
                        <span class="h6">${totalCostFormatted}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Lucro Líquido</strong><br>
                        <span class="h6">${profitFormatted}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Margem</strong><br>
                        <span class="h6">${profitMargin.toFixed(1)}%</span>
                    </div>
                </div>
            </div>
        `;
    } else if (profitDisplay && sellingPriceNum === 0) {
        profitDisplay.innerHTML = '';
    }
}

// Update chart when selling price changes
document.addEventListener('DOMContentLoaded', function() {
    const sellingPriceInput = document.getElementById('selling_price_brl');
    if (sellingPriceInput) {
        sellingPriceInput.addEventListener('input', function(e) {
            const sellingPrice = parseFloat(e.target.value) || 0;
            updateCostComparisonChart(sellingPrice);
        });
        
        sellingPriceInput.addEventListener('keyup', function(e) {
            const sellingPrice = parseFloat(e.target.value) || 0;
            updateCostComparisonChart(sellingPrice);
        });
    }
});

// Profitability calculation
document.getElementById('profitability-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const sellingPrice = parseFloat(formData.get('selling_price_brl'));
    const button = this.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculando...';
    button.disabled = true;
    
    // Update chart immediately
    if (sellingPrice && sellingPrice > 0) {
        updateCostComparisonChart(sellingPrice);
    }
    
    fetch(`/calcular-rentabilidade/{{ calculation.id }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayProfitabilityResults(data.data);
        } else {
            alert('Erro ao calcular rentabilidade: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao calcular rentabilidade');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
});

function displayProfitabilityResults(data) {
    const resultsDiv = document.getElementById('profitability-results');
    const cardsDiv = document.getElementById('profitability-cards');
    
    cardsDiv.innerHTML = `
        <div class="col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Lucro Bruto</h6>
                    <h5 class="text-success">R$ ${data.gross_profit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h5>
                    <small class="text-muted">${data.gross_margin.toFixed(1)}% margem</small>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Lucro Líquido</h6>
                    <h5 class="text-${data.net_profit > 0 ? 'success' : 'danger'}">R$ ${data.net_profit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h5>
                    <small class="text-muted">${data.net_margin.toFixed(1)}% margem</small>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">ROI</h6>
                    <h5 class="text-${data.roi > 0 ? 'success' : 'danger'}">${data.roi.toFixed(1)}%</h5>
                    <small class="text-muted">Retorno sobre investimento</small>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Custo Total Final</h6>
                    <h5 class="text-info">R$ ${data.total_cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h5>
                    <small class="text-muted">Incluindo todos os custos</small>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

// Save scenario
function saveScenario() {
    const formData = new FormData(document.getElementById('scenario-form'));
    
    fetch(`/salvar-cenario/{{ calculation.id }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('saveScenarioModal')).hide();
            // Show success message (you can add a toast notification here)
        } else {
            alert('Erro ao salvar cenário: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar cenário');
    });
}
</script>
{% endblock %}
