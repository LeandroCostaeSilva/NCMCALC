{% extends "base.html" %}

{% block title %}Resultados - Calculadora de Importação{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i data-feather="bar-chart-2" class="me-2"></i>Resultados da Análise</h2>
            <p class="text-muted">{{ calculation.product_name }} - NCM: {{ calculation.ncm_code }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <small class="text-muted">Cálculo realizado em {{ calculation.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
    </div>

    <div class="row">
        <!-- Main Results -->
        <div class="col-lg-8">
            <!-- Summary Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Valor CIF</h6>
                            <h4 class="text-primary">{{ currency_service.format_currency_brl(calculation.total_cost_brl) }}</h4>
                            <small class="text-muted">Cost, Insurance & Freight</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Total de Impostos</h6>
                            <h4 class="text-warning">{{ currency_service.format_currency_brl(calculation.total_taxes_brl) }}</h4>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Custo Total</h6>
                            <h4 class="text-success">{{ currency_service.format_currency_brl(calculation.final_cost_brl) }}</h4>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Carga Tributária</h6>
                            <h4 class="text-info">{{ "%.1f"|format((calculation.total_taxes_brl / calculation.total_cost_brl) * 100) }}%</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tax Breakdown -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="pie-chart" class="me-2"></i>Breakdown dos Impostos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Imposto</th>
                                    <th>Alíquota</th>
                                    <th>Base de Cálculo</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tax_type, tax_data in taxes.items() %}
                                <tr>
                                    <td>
                                        <strong>{{ tax_type }}</strong>
                                        <br><small class="text-muted">
                                            {% if tax_type == 'II' %}Imposto de Importação
                                            {% elif tax_type == 'IPI' %}Imposto sobre Produtos Industrializados
                                            {% elif tax_type == 'PIS' %}PIS-Importação
                                            {% elif tax_type == 'COFINS' %}COFINS-Importação
                                            {% elif tax_type == 'ICMS' %}ICMS
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>{{ "%.2f"|format(tax_data.rate) }}%</td>
                                    <td>{{ currency_service.format_currency_brl(tax_data.base_value) }}</td>
                                    <td class="text-end">{{ currency_service.format_currency_brl(tax_data.amount) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cost Comparison Chart -->
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <canvas id="costComparisonChart" height="300"></canvas>
                            </div>
                        </div>
                        <div id="profit-display" class="mt-3"></div>
                        <div class="text-center">
                            <small class="text-muted">* Informe um preço de venda na análise de rentabilidade para visualizar a comparação</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profitability Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="trending-up" class="me-2"></i>Análise de Rentabilidade</h5>
                </div>
                <div class="card-body">
                    <form id="profitability-form">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ profitability_form.selling_price_brl.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ profitability_form.selling_price_brl() }}
                                </div>
                                <div class="form-text">Informe o preço de venda desejado para análise de rentabilidade</div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="button" class="btn btn-success" onclick="generateProfitabilityReport()">
                                <i data-feather="file-text" class="me-2"></i>Gerar Relatório de Rentabilidade
                            </button>
                            <button type="button" class="btn btn-outline-primary ms-2" onclick="exportToPDF()" id="export-pdf-btn" style="display: none;">
                                <i data-feather="download" class="me-2"></i>Exportar PDF
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Product Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i data-feather="package" class="me-2"></i>Detalhes do Produto</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-6">Produto:</dt>
                        <dd class="col-6">{{ calculation.product_name }}</dd>
                        
                        <dt class="col-6">NCM:</dt>
                        <dd class="col-6">{{ calculation.ncm_code }}</dd>
                        
                        <dt class="col-6">Quantidade:</dt>
                        <dd class="col-6">{{ calculation.quantity }} un.</dd>
                        
                        <dt class="col-6">Valor Unit.:</dt>
                        <dd class="col-6">{{ currency_service.format_currency_usd(calculation.unit_value_usd) }}</dd>
                        
                        <dt class="col-6">Origem:</dt>
                        <dd class="col-6">{{ calculation.origin_country }}</dd>
                        
                        <dt class="col-6">Transporte:</dt>
                        <dd class="col-6">
                            {% if calculation.transport_mode == 'MARITIME' %}Marítimo
                            {% elif calculation.transport_mode == 'AIR' %}Aéreo
                            {% elif calculation.transport_mode == 'ROAD' %}Rodoviário
                            {% endif %}
                        </dd>
                        
                        <dt class="col-6">Câmbio:</dt>
                        <dd class="col-6">R$ {{ "%.4f"|format(calculation.exchange_rate) }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Additional Costs -->
            {% if costs %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i data-feather="dollar-sign" class="me-2"></i>Custos Adicionais</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for cost in costs %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ cost.description }}
                            {% if cost.amount_usd %}
                                <span>{{ currency_service.format_currency_usd(cost.amount_usd) }}</span>
                            {% else %}
                                <span>{{ currency_service.format_currency_brl(cost.amount_brl) }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h6><i data-feather="settings" class="me-2"></i>Ações</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveScenarioModal">
                            <i data-feather="bookmark" class="me-2"></i>Salvar como Cenário
                        </button>
                        
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i data-feather="printer" class="me-2"></i>Imprimir Relatório
                        </button>
                        
                        <a href="{{ url_for('new_calculation') }}" class="btn btn-success">
                            <i data-feather="plus-circle" class="me-2"></i>Nova Análise
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Scenario Modal -->
<div class="modal fade" id="saveScenarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salvar Cenário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scenario-form">
                    {{ scenario_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ scenario_form.name.label(class="form-label") }}
                        {{ scenario_form.name() }}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dados do cálculo
const costData = {
    cif: {{ calculation.total_cost_brl }},
    taxes: {{ calculation.total_taxes_brl }},
    additional: {% set additional_total = 0 %}{% for cost in costs %}{% set additional_total = additional_total + cost.amount_brl %}{% endfor %}{{ additional_total }},
    total: {{ calculation.total_cost_brl }} + {{ calculation.total_taxes_brl }} + {% set additional_total = 0 %}{% for cost in costs %}{% set additional_total = additional_total + cost.amount_brl %}{% endfor %}{{ additional_total }},
    quantity: {{ calculation.quantity }}
};

// Gráfico simples
let chart = null;

function initChart() {
    const ctx = document.getElementById('costComparisonChart');
    if (!ctx) return;
    
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Custo Total', 'Faturamento Total'],
            datasets: [{
                label: 'CIF',
                data: [costData.cif, 0],
                backgroundColor: '#0d6efd'
            }, {
                label: 'Impostos', 
                data: [costData.taxes, 0],
                backgroundColor: '#dc3545'
            }, {
                label: 'Custos Extras',
                data: [costData.additional, 0], 
                backgroundColor: '#ffc107'
            }, {
                label: 'Faturamento',
                data: [0, 0],
                backgroundColor: '#198754'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { 
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                        }
                    }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function updateChart(sellingPrice) {
    if (!chart) return;
    
    const unitPrice = parseFloat(sellingPrice) || 0;
    const totalRevenue = unitPrice * costData.quantity; // Faturamento = preço × quantidade
    
    // Atualizar a barra de faturamento no gráfico
    chart.data.datasets[3].data[1] = totalRevenue;
    chart.update('none'); // Update sem animação para melhor performance
    
    // Atualizar display de lucro
    updateProfitDisplay(unitPrice, totalRevenue);
}

function updateProfitDisplay(unitPrice, totalRevenue) {
    const profitDisplay = document.getElementById('profit-display');
    
    if (profitDisplay && unitPrice > 0) {
        // Calcular lucro líquido = Faturamento - Custo Total
        const netProfit = totalRevenue - costData.total;
        
        // Margem sobre o valor de compra (custo total)
        const profitMarginOnCost = (netProfit / costData.total) * 100;
        
        // Margem sobre o faturamento
        const profitMarginOnRevenue = (netProfit / totalRevenue) * 100;
        
        const alertType = netProfit > 0 ? 'success' : 'danger';
        const profitText = netProfit >= 0 ? 'Lucro' : 'Prejuízo';
        
        profitDisplay.innerHTML = `
            <div class="card">
                <div class="card-header bg-${alertType} text-white">
                    <h6 class="mb-0">Análise de Rentabilidade</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-md-3">
                            <strong>Custo Total</strong><br>
                            <span class="h5 text-danger">R$ ${costData.total.toFixed(2).replace('.', ',')}</span>
                            <small class="d-block text-muted">${costData.quantity} unidades</small>
                        </div>
                        <div class="col-md-3">
                            <strong>Preço Unitário</strong><br>
                            <span class="h5 text-primary">R$ ${unitPrice.toFixed(2).replace('.', ',')}</span>
                            <small class="d-block text-muted">por unidade</small>
                        </div>
                        <div class="col-md-3">
                            <strong>Faturamento Total</strong><br>
                            <span class="h5 text-info">R$ ${totalRevenue.toFixed(2).replace('.', ',')}</span>
                            <small class="d-block text-muted">${costData.quantity} × R$ ${unitPrice.toFixed(2).replace('.', ',')}</small>
                        </div>
                        <div class="col-md-3">
                            <strong>${profitText} Líquido</strong><br>
                            <span class="h5 text-${alertType}">R$ ${Math.abs(netProfit).toFixed(2).replace('.', ',')}</span>
                            <small class="d-block text-muted">${netProfit >= 0 ? '+' : '-'}${Math.abs(profitMarginOnCost).toFixed(1)}% sobre custo</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <small><strong>Margem sobre Compra:</strong><br>
                            <span class="text-${alertType}">${profitMarginOnCost.toFixed(1)}%</span></small>
                        </div>
                        <div class="col-md-4">
                            <small><strong>Margem sobre Venda:</strong><br>
                            <span class="text-${alertType}">${profitMarginOnRevenue.toFixed(1)}%</span></small>
                        </div>
                        <div class="col-md-4">
                            <small><strong>ROI:</strong><br>
                            <span class="text-${alertType}">${profitMarginOnCost.toFixed(1)}%</span></small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (profitDisplay) {
        profitDisplay.innerHTML = '';
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    
    // Procurar o campo de preço de venda tanto por ID quanto por name
    let priceInput = document.getElementById('selling_price_brl');
    if (!priceInput) {
        priceInput = document.querySelector('input[name="selling_price_brl"]');
    }
    
    if (priceInput) {
        // Adicionar múltiplos event listeners para garantir que funciona
        priceInput.addEventListener('input', function() {
            const value = parseFloat(this.value) || 0;
            updateChart(value);
        });
        
        priceInput.addEventListener('keyup', function() {
            const value = parseFloat(this.value) || 0;
            updateChart(value);
        });
        
        priceInput.addEventListener('change', function() {
            const value = parseFloat(this.value) || 0;
            updateChart(value);
        });
    }
});

// Gerar relatório de rentabilidade completo
function generateProfitabilityReport() {
    const priceInput = document.getElementById('selling_price_brl') || document.querySelector('input[name="selling_price_brl"]');
    
    if (!priceInput || !priceInput.value || parseFloat(priceInput.value) <= 0) {
        alert('Por favor, informe um preço de venda válido antes de gerar o relatório.');
        priceInput?.focus();
        return;
    }
    
    const unitPrice = parseFloat(priceInput.value);
    const totalRevenue = unitPrice * costData.quantity;
    const netProfit = totalRevenue - costData.total;
    const profitMarginOnCost = (netProfit / costData.total) * 100;
    const profitMarginOnRevenue = (netProfit / totalRevenue) * 100;
    
    // Atualizar gráfico
    updateChart(unitPrice);
    
    // Mostrar botão de exportar PDF
    const exportBtn = document.getElementById('export-pdf-btn');
    if (exportBtn) {
        exportBtn.style.display = 'inline-block';
    }
    
    // Adicionar seção de relatório completo
    let reportSection = document.getElementById('complete-report');
    if (!reportSection) {
        reportSection = document.createElement('div');
        reportSection.id = 'complete-report';
        reportSection.className = 'mt-4';
        
        const mainContainer = document.querySelector('.col-lg-8');
        if (mainContainer) {
            mainContainer.appendChild(reportSection);
        }
    }
    
    reportSection.innerHTML = `
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i data-feather="file-text" class="me-2"></i>Relatório Completo de Rentabilidade
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted">DADOS DO PRODUTO</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Produto:</strong></td><td>{{ calculation.product_name }}</td></tr>
                            <tr><td><strong>NCM:</strong></td><td>{{ calculation.ncm_code }}</td></tr>
                            <tr><td><strong>Quantidade:</strong></td><td>${costData.quantity} unidades</td></tr>
                            <tr><td><strong>Origem:</strong></td><td>{{ calculation.origin_country }}</td></tr>
                            <tr><td><strong>Câmbio:</strong></td><td>R$ {{ "%.4f"|format(calculation.exchange_rate) }}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">COMPOSIÇÃO DE CUSTOS</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Valor CIF:</strong></td><td>R$ ${costData.cif.toFixed(2).replace('.', ',')}</td></tr>
                            <tr><td><strong>Impostos:</strong></td><td>R$ ${costData.taxes.toFixed(2).replace('.', ',')}</td></tr>
                            <tr><td><strong>Custos Extras:</strong></td><td>R$ ${costData.additional.toFixed(2).replace('.', ',')}</td></tr>
                            <tr class="table-warning"><td><strong>TOTAL CUSTOS:</strong></td><td><strong>R$ ${costData.total.toFixed(2).replace('.', ',')}</strong></td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted">ANÁLISE DE RENTABILIDADE</h6>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Preço Unitário</h6>
                                        <h4 class="text-primary">R$ ${unitPrice.toFixed(2).replace('.', ',')}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Faturamento Total</h6>
                                        <h4 class="text-info">R$ ${totalRevenue.toFixed(2).replace('.', ',')}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">${netProfit >= 0 ? 'Lucro' : 'Prejuízo'} Líquido</h6>
                                        <h4 class="text-${netProfit >= 0 ? 'success' : 'danger'}">R$ ${Math.abs(netProfit).toFixed(2).replace('.', ',')}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Margem sobre Compra</h6>
                                        <h4 class="text-${netProfit >= 0 ? 'success' : 'danger'}">${profitMarginOnCost.toFixed(1)}%</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">INDICADORES</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ROI:</strong></td><td class="text-${netProfit >= 0 ? 'success' : 'danger'}">${profitMarginOnCost.toFixed(1)}%</td></tr>
                            <tr><td><strong>Margem sobre Venda:</strong></td><td>${profitMarginOnRevenue.toFixed(1)}%</td></tr>
                            <tr><td><strong>Markup:</strong></td><td>${(totalRevenue / costData.total).toFixed(2)}x</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">RESUMO</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Custo por Unidade:</strong></td><td>R$ ${(costData.total / costData.quantity).toFixed(2).replace('.', ',')}</td></tr>
                            <tr><td><strong>Lucro por Unidade:</strong></td><td class="text-${netProfit >= 0 ? 'success' : 'danger'}">R$ ${(netProfit / costData.quantity).toFixed(2).replace('.', ',')}</td></tr>
                            <tr><td><strong>Data do Cálculo:</strong></td><td>{{ calculation.created_at.strftime('%d/%m/%Y %H:%M') }}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Reativar ícones do Feather
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

// Exportar relatório para PDF
function exportToPDF() {
    const reportElement = document.getElementById('complete-report');
    if (!reportElement) {
        alert('Gere o relatório primeiro antes de exportar.');
        return;
    }
    
    // Usar window.print() para gerar PDF
    const originalContents = document.body.innerHTML;
    const reportContents = `
        <html>
        <head>
            <title>Relatório de Rentabilidade - {{ calculation.product_name }}</title>
            <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
            <style>
                @media print {
                    body { background: white !important; color: black !important; }
                    .card { border: 1px solid #ccc !important; }
                    .bg-success { background-color: #28a745 !important; }
                    .text-white { color: white !important; }
                    .text-success { color: #28a745 !important; }
                    .text-danger { color: #dc3545 !important; }
                    .text-info { color: #17a2b8 !important; }
                    .text-primary { color: #007bff !important; }
                }
            </style>
        </head>
        <body>
            <div class="container mt-3">
                <h2>NCMCALC - Calculadora de Importação</h2>
                ${reportElement.innerHTML}
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(reportContents);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// Save scenario function
function saveScenario() {
    const formData = new FormData(document.getElementById('scenario-form'));
    
    fetch(`/salvar-cenario/{{ calculation.id }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Cenário salvo com sucesso!');
            const modal = document.getElementById('saveScenarioModal');
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) modalInstance.hide();
            }
        } else {
            alert('Erro ao salvar cenário: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar cenário');
    });
}
</script>
{% endblock %}
