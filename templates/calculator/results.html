{% extends "base.html" %}

{% block title %}Resultados - Calculadora de Importação{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i data-feather="bar-chart-2" class="me-2"></i>Resultados da Análise</h2>
            <p class="text-muted">{{ calculation.product_name }} - NCM: {{ calculation.ncm_code }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <small class="text-muted">Cálculo realizado em {{ calculation.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
    </div>

    <div class="row">
        <!-- Main Results -->
        <div class="col-lg-8">
            <!-- Summary Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Valor CIF</h6>
                            <h4 class="text-primary">{{ currency_service.format_currency_brl(calculation.total_cost_brl) }}</h4>
                            <small class="text-muted">Cost, Insurance & Freight</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Total de Impostos</h6>
                            <h4 class="text-warning">{{ currency_service.format_currency_brl(calculation.total_taxes_brl) }}</h4>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Custo Total</h6>
                            <h4 class="text-success">{{ currency_service.format_currency_brl(calculation.final_cost_brl) }}</h4>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Carga Tributária</h6>
                            <h4 class="text-info">{{ "%.1f"|format((calculation.total_taxes_brl / calculation.total_cost_brl) * 100) }}%</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tax Breakdown -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="pie-chart" class="me-2"></i>Breakdown dos Impostos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Imposto</th>
                                    <th>Alíquota</th>
                                    <th>Base de Cálculo</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tax_type, tax_data in taxes.items() %}
                                <tr>
                                    <td>
                                        <strong>{{ tax_type }}</strong>
                                        <br><small class="text-muted">
                                            {% if tax_type == 'II' %}Imposto de Importação
                                            {% elif tax_type == 'IPI' %}Imposto sobre Produtos Industrializados
                                            {% elif tax_type == 'PIS' %}PIS-Importação
                                            {% elif tax_type == 'COFINS' %}COFINS-Importação
                                            {% elif tax_type == 'ICMS' %}ICMS
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>{{ "%.2f"|format(tax_data.rate) }}%</td>
                                    <td>{{ currency_service.format_currency_brl(tax_data.base_value) }}</td>
                                    <td class="text-end">{{ currency_service.format_currency_brl(tax_data.amount) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cost Comparison Chart -->
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <canvas id="costComparisonChart" height="300"></canvas>
                            </div>
                        </div>
                        <div id="profit-display" class="mt-3"></div>
                        <div class="text-center">
                            <small class="text-muted">* Informe um preço de venda na análise de rentabilidade para visualizar a comparação</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profitability Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="trending-up" class="me-2"></i>Análise de Rentabilidade</h5>
                </div>
                <div class="card-body">
                    <form id="profitability-form">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ profitability_form.selling_price_brl.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ profitability_form.selling_price_brl() }}
                                </div>
                                <div class="form-text">Informe o preço de venda desejado para análise de rentabilidade</div>
                            </div>
                        </div>

                        <div class="text-center">
                            {{ profitability_form.submit() }}
                        </div>
                    </form>

                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Product Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i data-feather="package" class="me-2"></i>Detalhes do Produto</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-6">Produto:</dt>
                        <dd class="col-6">{{ calculation.product_name }}</dd>
                        
                        <dt class="col-6">NCM:</dt>
                        <dd class="col-6">{{ calculation.ncm_code }}</dd>
                        
                        <dt class="col-6">Quantidade:</dt>
                        <dd class="col-6">{{ calculation.quantity }} un.</dd>
                        
                        <dt class="col-6">Valor Unit.:</dt>
                        <dd class="col-6">{{ currency_service.format_currency_usd(calculation.unit_value_usd) }}</dd>
                        
                        <dt class="col-6">Origem:</dt>
                        <dd class="col-6">{{ calculation.origin_country }}</dd>
                        
                        <dt class="col-6">Transporte:</dt>
                        <dd class="col-6">
                            {% if calculation.transport_mode == 'MARITIME' %}Marítimo
                            {% elif calculation.transport_mode == 'AIR' %}Aéreo
                            {% elif calculation.transport_mode == 'ROAD' %}Rodoviário
                            {% endif %}
                        </dd>
                        
                        <dt class="col-6">Câmbio:</dt>
                        <dd class="col-6">R$ {{ "%.4f"|format(calculation.exchange_rate) }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Additional Costs -->
            {% if costs %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i data-feather="dollar-sign" class="me-2"></i>Custos Adicionais</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for cost in costs %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ cost.description }}
                            {% if cost.amount_usd %}
                                <span>{{ currency_service.format_currency_usd(cost.amount_usd) }}</span>
                            {% else %}
                                <span>{{ currency_service.format_currency_brl(cost.amount_brl) }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h6><i data-feather="settings" class="me-2"></i>Ações</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveScenarioModal">
                            <i data-feather="bookmark" class="me-2"></i>Salvar como Cenário
                        </button>
                        
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i data-feather="printer" class="me-2"></i>Imprimir Relatório
                        </button>
                        
                        <a href="{{ url_for('new_calculation') }}" class="btn btn-success">
                            <i data-feather="plus-circle" class="me-2"></i>Nova Análise
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Scenario Modal -->
<div class="modal fade" id="saveScenarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salvar Cenário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scenario-form">
                    {{ scenario_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ scenario_form.name.label(class="form-label") }}
                        {{ scenario_form.name() }}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dados do cálculo
const costData = {
    cif: {{ calculation.total_cost_brl }},
    taxes: {{ calculation.total_taxes_brl }},
    additional: {% set additional_total = 0 %}{% for cost in costs %}{% set additional_total = additional_total + cost.amount_brl %}{% endfor %}{{ additional_total }},
    total: {{ calculation.total_cost_brl }} + {{ calculation.total_taxes_brl }} + {% set additional_total = 0 %}{% for cost in costs %}{% set additional_total = additional_total + cost.amount_brl %}{% endfor %}{{ additional_total }}
};

// Gráfico simples
let chart = null;

function initChart() {
    console.log('Inicializando chart...');
    console.log('Dados de custo:', costData);
    
    const ctx = document.getElementById('costComparisonChart');
    if (!ctx) {
        console.error('Canvas costComparisonChart não encontrado');
        return;
    }
    
    console.log('Canvas encontrado, criando chart...');
    
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Custo Total', 'Preço de Venda'],
            datasets: [{
                label: 'CIF',
                data: [costData.cif, 0],
                backgroundColor: '#0d6efd'
            }, {
                label: 'Impostos', 
                data: [costData.taxes, 0],
                backgroundColor: '#dc3545'
            }, {
                label: 'Custos Extras',
                data: [costData.additional, 0], 
                backgroundColor: '#ffc107'
            }, {
                label: 'Receita',
                data: [0, 0],
                backgroundColor: '#198754'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { 
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                        }
                    }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    
    console.log('Chart criado com sucesso:', chart);
}

function updateChart(sellingPrice) {
    console.log('updateChart chamada com preço:', sellingPrice);
    
    if (!chart) {
        console.error('Chart não encontrado');
        return;
    }
    
    const price = parseFloat(sellingPrice) || 0;
    console.log('Preço processado:', price);
    
    // Atualizar a barra de receita no gráfico
    chart.data.datasets[3].data[1] = price;
    chart.update('none'); // Update sem animação para melhor performance
    
    // Atualizar display de lucro
    updateProfitDisplay(price);
    
    console.log('Chart atualizado com sucesso');
}

function updateProfitDisplay(sellingPrice) {
    const profit = sellingPrice - costData.total;
    const margin = sellingPrice > 0 ? (profit / sellingPrice) * 100 : 0;
    const profitDisplay = document.getElementById('profit-display');
    
    if (profitDisplay && sellingPrice > 0) {
        const alertType = profit > 0 ? 'success' : 'danger';
        const profitText = profit >= 0 ? 'Lucro' : 'Prejuízo';
        
        profitDisplay.innerHTML = `
            <div class="card">
                <div class="card-header bg-${alertType} text-white">
                    <h6 class="mb-0">Análise de Rentabilidade</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <strong>Custo Total</strong><br>
                            <span class="h5 text-danger">R$ ${costData.total.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Preço de Venda</strong><br>
                            <span class="h5 text-primary">R$ ${sellingPrice.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>${profitText} Líquido</strong><br>
                            <span class="h5 text-${alertType}">R$ ${Math.abs(profit).toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Margem</strong><br>
                            <span class="h5 text-${alertType}">${margin.toFixed(1)}%</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>ROI:</strong> ${(profit / costData.total * 100).toFixed(1)}%</small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>Markup:</strong> ${(sellingPrice / costData.total).toFixed(2)}x</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (profitDisplay) {
        profitDisplay.innerHTML = '';
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    
    // Procurar o campo de preço de venda tanto por ID quanto por name
    let priceInput = document.getElementById('selling_price_brl');
    if (!priceInput) {
        priceInput = document.querySelector('input[name="selling_price_brl"]');
    }
    
    if (priceInput) {
        console.log('Campo de preço encontrado:', priceInput);
        
        // Adicionar múltiplos event listeners para garantir que funciona
        priceInput.addEventListener('input', function() {
            const value = parseFloat(this.value) || 0;
            console.log('Preço informado:', value);
            updateChart(value);
        });
        
        priceInput.addEventListener('keyup', function() {
            const value = parseFloat(this.value) || 0;
            updateChart(value);
        });
        
        priceInput.addEventListener('change', function() {
            const value = parseFloat(this.value) || 0;
            updateChart(value);
        });
    } else {
        console.error('Campo selling_price_brl não encontrado');
        // Tentar encontrar qualquer input de número na página
        const allInputs = document.querySelectorAll('input[type="number"]');
        console.log('Inputs encontrados:', allInputs);
    }
});

// Save scenario function
function saveScenario() {
    const formData = new FormData(document.getElementById('scenario-form'));
    
    fetch(`/salvar-cenario/{{ calculation.id }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Cenário salvo com sucesso!');
            // Hide modal if exists
            const modal = document.getElementById('saveScenarioModal');
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) modalInstance.hide();
            }
        } else {
            alert('Erro ao salvar cenário: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar cenário');
    });
}
</script>
{% endblock %}
